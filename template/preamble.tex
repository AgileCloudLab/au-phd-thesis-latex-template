%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Template Introduction %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Purpose: PhD Thesis LaTeX template
% Institution: Aarhus University Department of Electrical and Computer Engineering
% Website: https://github.com/AgileCloudLab/au-phd-thesis-latex-template/
% The template provides a base skeleton for a PhD thesis for students
% at ECE at Aarhus University.
%
% The template is based on the EDOC Template version 2011 but has bee update to use
% modern LaTeX packages.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Document layout setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifx \thesisPaperSize \undefined
	\def \thesisPaperSize {a4paper}
\fi


\documentclass[\thesisPaperSize, 11pt, twoside, openright, svgnames, dvinames, dvipsnames, table]{book}

\usepackage{xstring}

\IfStrEq{a4paper}{\thesisPaperSize}{
	\def \thesisPaperMarginTop {25mm}
	\def \thesisPaperMarginBottom {20mm}
	\def \thesisPaperMarginInner {25mm}
	\def \thesisPaperMarginOuter {25mm}
}{}

\IfStrEq{a5paper}{\thesisPaperSize}{
	\def \thesisPaperMarginTop {18mm}
	\def \thesisPaperMarginBottom {14mm}
	\def \thesisPaperMarginInner {18mm}
	\def \thesisPaperMarginOuter {18mm}
      }{}

\usepackage[\thesisPaperSize, top=\thesisPaperMarginTop, bottom=\thesisPaperMarginBottom, inner=\thesisPaperMarginInner, outer=\thesisPaperMarginOuter]{geometry}

\setlength{\headheight}{13.6pt}

\usepackage{setspace} % increase interline spacing slightly
\setstretch{1.1}
\onehalfspacing

\usepackage{parskip}
\setlength{\parindent}{0em} % Disable indentations of new paragraphs

\usepackage{fancyhdr}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead[OR]{\bfseries \nouppercase{\rightmark}}
\fancyhead[EL]{\bfseries \nouppercase{\leftmark}}
\fancyfoot[C]{\thepage}
\fancypagestyle{plain}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
  \fancyfoot[C]{\thepage}}
\fancypagestyle{addpagenumbersforpdfimports}{
  \fancyhead{}
  \renewcommand{\headrulewidth}{0pt}
  \fancyfoot{}
  \fancyfoot[C]{\thepage}
}

% To make quotes (https://tex.stackexchange.com/questions/53377/inspirational-quote-at-start-of-chapter)
\usepackage{epigraph} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Document layout setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Font and Language Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{bookman} % Select bookman font type. Similar to Georgia
\usepackage{fourier} % Utopia font-typesetting including mathematical formula compatible with newer TeX-Distributions (>2010)
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[danish,english]{babel}
\usepackage{microtype} %Optimise typesetting (distance between characters in m)
\usepackage[binary-units=true,separate-uncertainty=true,multi-part-units=single]{siunitx} % Write SI units properly
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Font and Language Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Colour Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{xcolor}
\definecolor{AU_Black}{RGB}{0,0,0}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [END] COLOUR SETUP%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Maths Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{amsmath}
\usepackage{amsthm} % Provides the environment proof
\usepackage{nicefrac}

% Fix the problem with delimiter size caused by fourier and amsmath packages.
\makeatletter
\def\resetMathstrut@{%
  \setbox\z@\hbox{%
    \mathchardef\@tempa\mathcode`\(\relax
      \def\@tempb##1"##2##3{\the\textfont"##3\char"}%
      \expandafter\@tempb\meaning\@tempa \relax
  }%
  \ht\Mathstrutbox@1.2\ht\z@ \dp\Mathstrutbox@1.2\dp\z@
}
\makeatother

\widowpenalty 10000
\clubpenalty 10000
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Maths Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Nifty packages for abbreviations %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[abbreviations]{foreign}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Nifty packages for abbreviations %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Figure and Default graphics Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{subcaption} % Introduce subfigure and other nice things
% The caption package is used for subfloats and caption editing
% The format=hang option make a small indent of the caption so the lines "hang" under each other.
% This can be removed or change to format=plain to avoid the indentation
\usepackage[font=small, format=hang]{caption}
\usepackage[final]{pdfpages} % Allows for PDF including in the thesis using \includepdf{}

\usepackage[bottom]{footmisc} % Place footnotes below figures

\makeatletter
\setlength{\@fptop}{0pt}  % for aligning all floating figures/tables etc... to the top margin
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Figure and Default graphics Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Settings for itemised lists Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{enumitem}
\setitemize{noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [Stop] Settings for itemised lists Setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Tikz %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tikz are used to draw the chapter and part sections 
\usepackage{tikz}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Tikz %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Tables %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This package provides nice commands for the default table environment in LaTeX
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{tabu}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Tables %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] citation and reference setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Improved citation 
\usepackage{cite}
%Print bib entry in txt
\usepackage{bibentry}

% % Hide the section in toc
\newcommand{\nocontentsline}[3]{}
\newcommand{\tocless}[2]{\bgroup\let\addcontentsline=\nocontentsline#1{#2}\egroup}

% Allow the thesis to have bib in each chapter
\usepackage[sectionbib]{chapterbib}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] citation and reference setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Custom part, chapter and section design %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[explicit]{titlesec}

\newcommand*\chapterlabel{}
%\renewcommand{\thechapter}{\Roman{chapter}}
\titleformat{\chapter}[display]  % type (section,chapter,etc...) to vary,  shape (eg display-type)
	{\normalfont\bfseries\Huge} % format of the chapter
	{\gdef\chapterlabel{\thechapter\ }}     % the label 
 	{0pt} % separation between label and chapter-title
 	  {\begin{tikzpicture}[remember picture,overlay]
    %\node[yshift=-0.4\textheight,xshift=-10mm] at (current page.north west)
    \node[yshift=-71.2mm,xshift=-10mm] at (current page.north west)
      {\begin{tikzpicture}[remember picture, overlay]
        \fill[fill=AU_Black] (0,0) rectangle(0.3\textwidth+10mm,0.05\textheight);
        %\fill[fill=AU_Black] (0,0) rectangle(0.3\textwidth+10mm,17.8mm);
        	%\node[anchor=north east,yshift=-0.29\textheight,xshift=0.28\textwidth,minimum height=0.3\textheight,inner sep=0mm] at (current page.north west){\parbox[top][30mm][t]{15mm}{\raggedleft $\phantom{\textrm{l}}$\color{white}\chapterlabel}};  %the black l is just to get better base-line alingement
        	\node[anchor=north east,yshift=-61.62mm,xshift=0.3\textwidth-3mm,minimum height=30mm,inner sep=0mm] at (current page.north west){\parbox[top][30mm][t]{15mm}{\raggedleft $\phantom{\textrm{l}}$\color{white}\chapterlabel}};  %the black l is just to get better base-line alingement
        %\node[anchor=north west,yshift=-0.29\textheight,xshift=0.32\textwidth,text width=\textwidth-17mm,minimum height=0.3\textheight,inner sep=0mm] at (current page.north west){\parbox[top][30mm][t]{\textwidth}{\color{black}#1}};
        	\node[anchor=north west,yshift=-61.62mm,xshift=0.3\textwidth+3mm,text width=\textwidth-17mm,minimum height=30mm,inner sep=0mm] at (current page.north west){\parbox[top][30mm][t]{\textwidth}{\color{AU_Black}#1}};
       \end{tikzpicture}
      };
   \end{tikzpicture}
   \gdef\chapterlabel{}
  } % code before the title body
  

\titlespacing*{\chapter}{0pt}{80pt}{30pt}
\titlespacing*{\section}{0pt}{13.2pt}{*0}  % 13.2pt is line spacing for a text with 11pt font size
\titlespacing*{\subsection}{0pt}{13.2pt}{*0}
\titlespacing*{\subsubsection}{0pt}{13.2pt}{*0}

\newcounter{myparts}
\newcommand*\partlabel{}
\titleformat{\part}[display]  % type (section,chapter,etc...) to vary,  shape (eg display-type)
	{\normalfont\bfseries\Huge} % format of the part
	{\gdef\partlabel{\thepart\ }}     % the label 
 	{0pt} % separation between label and part-title
 	  {\setlength{\unitlength}{20mm}
	  \addtocounter{myparts}{1}
	  \begin{tikzpicture}[remember picture,overlay]
%    \node[anchor=north west,xshift=-45mm,yshift=-3.9cm-\value{myparts}*20mm] at (current page.north east) % for unknown
    \node[anchor=north west,xshift=-45mm,yshift=-3.9cm-\value{myparts}*20mm] at (current page.north east) % for unknown reasons: 3mm missing -> 65 instead of 62-(43.5mm,30.75mm)
      {\begin{tikzpicture}[remember picture, overlay]
        \fill[fill=AU_Black] (0,-2) rectangle(60mm,20mm);   % -\value{myparts}\unitlength
%        \fill[fill=AU_Black] (43.5mm,30.75mm) rectangle(42mm,20mm);   % -\value{myparts}\unitlength        
        \node[anchor=north west,yshift=-3.1cm-\value{myparts}*20mm,xshift=-40.5mm,minimum height=30mm,inner sep=0mm] at (current page.north east){\parbox[top][30mm][t]{55mm}{\raggedright \color{white}Part \partlabel $\phantom{\textrm{l}}$}};  %the phantom l is just to get better base-line alingement
        \node[anchor=north east,yshift=-3.1cm-\value{myparts}*20mm,xshift=-45mm,text width=\textwidth-27mm,minimum height=30mm,inner sep=0mm] at (current page.north east)  {\parbox[top][30mm][t]{\textwidth}{\raggedleft \color{AU_Black}#1}};
       \end{tikzpicture}
      };
   \end{tikzpicture}
   \gdef\partlabel{}
  } % code before the title body

\titleformat{\section}[hang]
{\normalfont\Large\bfseries\color{AU_Black}}
{\thesection\hskip 11pt}
{0em}
{#1}

% Reference to chapter and part names
% See: https://tex.stackexchange.com/questions/62241/how-to-get-the-current-chapter-name-section-name-subsection-name-etc
\let\Partmark\partmark
\def\partmark#1{\def\Partname{#1}\Partmark{#1}}
\let\Chaptermark\chaptermark
\def\chaptermark#1{\def\Chaptername{#1}\Chaptermark{#1}}
\let\Sectionmark\sectionmark
\def\sectionmark#1{\def\Sectionname{#1}\Sectionmark{#1}}
\let\Subsectionmark\subsectionmark
\def\subsectionmark#1{\def\Subsectionname{#1}\Subsectionmark{#1}}
\let\Subsubsectionmark\subsubsectionmark
\def\subsubsectionmark#1{\def\Subsubsectionname{#1}\Subsubsectionmark{#1}}

% Adding environment for abstract
\newenvironment{abstract}{\section*{Abstract}\it}{}

\addto\captionsenglish{%this line is required when using the babel package
  \renewcommand\bibname{References} % change Bibliography to references
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Custom part, chapter and section design %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Setup glossary %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{makeidx}
\makeindex
\usepackage[acronym,nomain,shortcuts]{glossaries} % [nonumberlist]
\renewcommand{\glossarysection}[2][]{} % Hack to remove titles from glossary lists
\makenoidxglossaries
\input{glossaries}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Setup glossary %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Paper collection setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{collect}
\definecollection{papers}
\newcounter{PapersCounter}
\makeatletter
\newenvironment{paper}[6]
{\@nameuse{collect}{papers}{}
    {}
    {\clearpage \stepcounter{PapersCounter} \paperlabel{#1}{\thePapersCounter} \chapter*{Paper \thePapersCounter}\addcontentsline{toc}{section}{Paper \thePapersCounter : #2}\textbf{#2}\\\textit{#3}\\ \vspace{10 mm}\\#4 \vspace{10 mm}\\#5 \vspace{0 mm}\\\textit{#6} \newpage}
    {}%
}
{\@nameuse{endcollect}}
\makeatother

% Setup referencing of papers
\makeatletter
\newcommand{\paperlabel}[2]{%
    \protected@write \@auxout {}{\string \newlabel {#1}{{Paper #2}{\thepage}{#2}{#1}{}} }%
    \hypertarget{#1}{}
}
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Paper collection setup %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] URL include %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Include before custom settings to avoid altercations 
% Helps including url's in bibtex and in text itself 
\usepackage[hyphens]{url}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [END] URL include %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Include custom settings %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{template/settings_custom}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Include custom settings %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Include our commands %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{template/commands}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Include our commands %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [START] Set up External and Internal References %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% a bit nicer organisation for hyperref
\usepackage{bookmark}
\usepackage{hyperref}
\hypersetup{pdfborder={0 0 0},
  linkcolor=black,
  citecolor=black,
  urlcolor=black}
\urlstyle{same}

%% The following allows for referencing papers by name when calling \ref
\usepackage{nameref}
\makeatletter
\newcommand*{\currentname}{\@currentlabelname}
\makeatother

\usepackage[noabbrev]{cleveref} % Load after hyperref to make clickable links
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% [STOP] Set up External and Internal References %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
